# ============================================================================
# CD - Canary Deploy to Azure Container Apps
# CDæµæ°´çº¿ - é‡‘ä¸é›€éƒ¨ç½²åˆ°Azureå®¹å™¨åº”ç”¨
# ============================================================================
# Trigger: After CI workflow completes successfully
# è§¦å‘æ¡ä»¶: CIæµæ°´çº¿æˆåŠŸå®Œæˆåè‡ªåŠ¨è§¦å‘
# ============================================================================
# Deployment Strategy (éƒ¨ç½²ç­–ç•¥):
#   0% smoke test (labelç›´è¿) â†’ 10% â†’ 50% â†’ 100%
#   Health check at each stage, auto-rollback on failure
#   æ¯é˜¶æ®µå¥åº·æ£€æŸ¥ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
# ============================================================================

name: CD - Canary Deploy to Azure Container Apps

on:
  workflow_run:
    workflows: ["CI - Build Scan SBOM Sign Push to GHCR"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  AZURE_RESOURCE_GROUP: rg-genai-student-jp
  AZURE_CONTAINER_APP_NAME: serverless-rag-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy on success or manual trigger
    # ä»…åœ¨CIæˆåŠŸæˆ–æ‰‹åŠ¨è§¦å‘æ—¶éƒ¨ç½²
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Prepare image URL | å‡†å¤‡é•œåƒåœ°å€
      - name: Prepare image url
        id: image-prep
        shell: bash
        run: |
          set -euo pipefail
          FULL_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          LOWER_IMAGE=$(echo "$FULL_IMAGE" | tr '[:upper:]' '[:lower:]')

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="latest"
          else
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="sha-${SHA:0:7}"
          fi

          echo "image_url=$LOWER_IMAGE:$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ³ Using image: $LOWER_IMAGE:$TAG"

      # ========== Step 1: Enable multiple revisions ==========
      # æ­¥éª¤1: å¯ç”¨å¤šç‰ˆæœ¬æ¨¡å¼ï¼ˆé‡‘ä¸é›€éƒ¨ç½²å’Œå›æ»šçš„å‰ææ¡ä»¶ï¼‰
      - name: Ensure Multiple Revisions mode
        shell: bash
        run: |
          set -euo pipefail
          az extension add --name containerapp --upgrade
          az containerapp update \
            -g "${{ env.AZURE_RESOURCE_GROUP }}" \
            -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
            --revisions-mode multiple

      # ========== Step 2: Deploy new revision ==========
      # æ­¥éª¤2: éƒ¨ç½²æ–°é•œåƒï¼ˆåˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰
      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          imageToDeploy: ${{ steps.image-prep.outputs.image_url }}
          registryUrl: ${{ env.REGISTRY }}
          registryUsername: ${{ github.actor }}
          registryPassword: ${{ secrets.GITHUB_TOKEN }}

      # ========== Step 3: Canary rollout ==========
      # æ­¥éª¤3: é‡‘ä¸é›€å‘å¸ƒæµç¨‹
      #   - 0%: Labelç›´è¿æµ‹æ´»ï¼ˆä¸å½±å“ç”Ÿäº§æµé‡ï¼‰
      #   - 10%: å°è§„æ¨¡éªŒè¯
      #   - 50%: æ‰©å¤§èŒƒå›´
      #   - 100%: å…¨é‡åˆ‡æ¢
      #   - ä»»ä½•é˜¶æ®µå¥åº·æ£€æŸ¥å¤±è´¥åˆ™è‡ªåŠ¨å›æ»š
      - name: Canary rollout logic
        shell: bash
        run: |
          set -euo pipefail

          RG="${{ env.AZURE_RESOURCE_GROUP }}"
          APP="${{ env.AZURE_CONTAINER_APP_NAME }}"

          echo "ğŸ” Resolving FQDN..."
          FQDN=$(az containerapp show -g "$RG" -n "$APP" --query "properties.configuration.ingress.fqdn" -o tsv)
          if [ -z "$FQDN" ] || [ "$FQDN" = "None" ]; then
            echo "âŒ Ingress FQDN not found. Ensure External Ingress is enabled in ACA."
            exit 1
          fi

          # Get new revision (latest by createdTime)
          # è·å–æ–°ç‰ˆæœ¬ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºå–æœ€æ–°ï¼‰
          NEW_REV=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by([].{name:name, created:properties.createdTime}, &created)[-1].name" -o tsv)

          if [ -z "$NEW_REV" ] || [ "$NEW_REV" = "None" ]; then
            echo "âŒ Failed to resolve NEW_REV."
            exit 1
          fi

          # Get stable revision (highest traffic weight)
          # è·å–ç¨³å®šç‰ˆæœ¬ï¼ˆæµé‡æƒé‡æœ€é«˜çš„ç‰ˆæœ¬ï¼‰
          STABLE_REV=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by([?properties.trafficWeight!=null && properties.trafficWeight>\`0\`].{name:name, w:properties.trafficWeight}, &w)[-1].name" -o tsv || true)

          echo "ğŸ†• New Revision: $NEW_REV"
          echo "ğŸ›¡ï¸ Stable Revision: ${STABLE_REV:-<none>}"

          # Health check URLs | å¥åº·æ£€æŸ¥åœ°å€
          CANARY_URL="https://canary---${FQDN}/health"
          MAIN_URL="https://${FQDN}/health"

          echo "ğŸ©º Canary URL: $CANARY_URL"
          echo "ğŸ©º Main URL:   $MAIN_URL"

          # Health check function | å¥åº·æ£€æŸ¥å‡½æ•°
          check_health() {
            local url="$1"
            local timeout="${2:-10}"
            echo "ğŸ” Testing: $url"
            for i in {1..12}; do
              if curl -fsS --max-time "$timeout" "$url" >/dev/null 2>&1; then
                echo "âœ… Health check passed!"
                return 0
              fi
              echo "â³ Waiting for service to be ready ($i/12)..."
              sleep 10
            done
            echo "âŒ Health check failed after 2 minutes."
            return 1
          }

          # Rollback function | å›æ»šå‡½æ•°
          rollback() {
            if [ -z "${STABLE_REV:-}" ] || [ "$STABLE_REV" = "None" ]; then
              echo "ğŸš¨ No stable revision to rollback to (likely first deployment)."
              exit 1
            fi
            echo "ğŸš¨ Rolling back 100% traffic to $STABLE_REV"
            az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=100"
            echo "ğŸ’¤ Deactivating failed new revision $NEW_REV (best-effort)"
            az containerapp revision deactivate -g "$RG" -n "$APP" --revision "$NEW_REV" || true
            exit 1
          }

          # === First deployment (no stable revision) ===
          # === é¦–æ¬¡éƒ¨ç½²ï¼ˆæ— ç¨³å®šç‰ˆæœ¬ï¼‰===
          if [ -z "${STABLE_REV:-}" ] || [ "$STABLE_REV" = "None" ] || [ "$NEW_REV" = "$STABLE_REV" ]; then
            echo "âš ï¸ First deployment (or no stable revision). Route 100% to NEW_REV and health check main URL."
            az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$NEW_REV=100"
            echo "â³ Waiting for container to start (15s)..."
            sleep 15
            if ! check_health "$MAIN_URL" 15; then
              echo "âŒ First deployment failed health check."
              exit 1
            fi
            echo "ğŸ‰ First deployment success!"
            exit 0
          fi

          # === Canary deployment flow ===
          # === é‡‘ä¸é›€éƒ¨ç½²æµç¨‹ ===

          # Remove old canary label | ç§»é™¤æ—§çš„canaryæ ‡ç­¾
          echo "ğŸ·ï¸ Removing any existing 'canary' label (best-effort)..."
          az containerapp revision label remove --name "$APP" --resource-group "$RG" --label canary || true

          # Add canary label to new revision | ç»™æ–°ç‰ˆæœ¬æ‰“ä¸Šcanaryæ ‡ç­¾
          echo "ğŸ·ï¸ Assigning 'canary' label to $NEW_REV..."
          az containerapp revision label add \
            --name "$APP" \
            --resource-group "$RG" \
            --revision "$NEW_REV" \
            --label canary

          # Stage 0: 0% smoke test (label URL) | é˜¶æ®µ0: 0%å†’çƒŸæµ‹è¯•
          echo "ğŸ§ª Smoke testing via label URL (0% production traffic)..."
          echo "â³ Waiting for container to start (15s)..."
          sleep 15
          if ! check_health "$CANARY_URL" 15; then rollback; fi

          # Stage 1: 10% | é˜¶æ®µ1: 10%æµé‡
          echo "ğŸ¤ Shifting 10% traffic to new revision..."
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=90" "$NEW_REV=10"
          echo "â³ Waiting for traffic to propagate (10s)..."
          sleep 10
          if ! check_health "$CANARY_URL"; then rollback; fi

          # Stage 2: 50% | é˜¶æ®µ2: 50%æµé‡
          echo "âš–ï¸ Shifting 50% traffic..."
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=50" "$NEW_REV=50"
          echo "â³ Waiting for traffic to propagate (10s)..."
          sleep 10
          if ! check_health "$CANARY_URL"; then rollback; fi

          # Stage 3: 100% | é˜¶æ®µ3: 100%å…¨é‡
          echo "ğŸš€ Promoting to 100% traffic..."
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$NEW_REV=100"
          echo "â³ Waiting for traffic to propagate (5s)..."
          sleep 5
          if ! check_health "$MAIN_URL"; then rollback; fi

          # Deactivate old revision (save resources) | åœç”¨æ—§ç‰ˆæœ¬ï¼ˆèŠ‚çœèµ„æºï¼‰
          echo "ğŸ’¤ Deactivating old stable revision $STABLE_REV (optional)..."
          az containerapp revision deactivate -g "$RG" -n "$APP" --revision "$STABLE_REV" || true

          echo "ğŸ‰ Canary Deployment Success!"
          echo "ğŸ“Š Final state:"
          echo "  - New revision: $NEW_REV (100% traffic)"
          echo "  - Old revision: $STABLE_REV (deactivated)"
          echo "  - Canary URL: $CANARY_URL"
          echo "  - Production URL: $MAIN_URL"

      # ========== Summary ==========
      - name: Deployment Summary
        if: success()
        shell: bash
        run: |
          echo "### âœ… CD Completed | éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container App:** \`${{ env.AZURE_CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Strategy:** Canary (0% smoke â†’ 10% â†’ 50% â†’ 100%)" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²ç­–ç•¥:** é‡‘ä¸é›€ (0%å†’çƒŸ â†’ 10% â†’ 50% â†’ 100%)" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed Summary
        if: failure()
        shell: bash
        run: |
          echo "### âŒ CD Failed | éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container App:** \`${{ env.AZURE_CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ Traffic should have been rolled back to the stable revision (if existed)." >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ æµé‡å·²è‡ªåŠ¨å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚" >> $GITHUB_STEP_SUMMARY
