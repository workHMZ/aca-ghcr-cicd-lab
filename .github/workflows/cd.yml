name: CD - Deploy to Azure Container Apps

on:
  workflow_run:
    workflows: ["CI - Build and Push to GHCR"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  AZURE_CONTAINER_APP_NAME: serverless-rag-api
  AZURE_RESOURCE_GROUP: rg-genai-student-jp

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Prepare Lowercase Image Name
        id: image-prep
        run: |
          # èŽ·å–æ­£ç¡®çš„ SHA (workflow_dispatch ç”¨ github.sha)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="latest"
          else
            # workflow_run è§¦å‘æ—¶ä½¿ç”¨è§¦å‘å®ƒçš„ CI çš„ head_sha
            SHA="${{ github.event.workflow_run.head_sha }}"
            # SHA å–å‰7ä½ä½œä¸º tag (å’Œ CI çš„ type=sha ä¸€è‡´)
            TAG="sha-${SHA:0:7}"
          fi
          
          # æ‹¼æŽ¥å¹¶å¼ºåˆ¶è½¬ä¸ºå…¨å°å†™
          FULL_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          LOWER_IMAGE=$(echo "$FULL_IMAGE" | tr '[:upper:]' '[:lower:]')
          
          echo "image_url=$LOWER_IMAGE:$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ³ Using image: $LOWER_IMAGE:$TAG"

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          imageToDeploy: ${{ steps.image-prep.outputs.image_url }}
          
      - name: Output deployment info
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY