name: CD - Canary Deploy to Azure Container Apps

on:
  workflow_run:
    workflows: ["CI - Build Scan SBOM Sign Push to GHCR"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  AZURE_RESOURCE_GROUP: rg-genai-student-jp
  AZURE_CONTAINER_APP_NAME: serverless-rag-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Prepare image url
        id: image-prep
        shell: bash
        run: |
          set -euo pipefail
          FULL_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          LOWER_IMAGE=$(echo "$FULL_IMAGE" | tr '[:upper:]' '[:lower:]')

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="latest"
          else
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="sha-${SHA:0:7}"
          fi

          echo "image_url=$LOWER_IMAGE:$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ³ Using image: $LOWER_IMAGE:$TAG"

      # 1) å¼ºåˆ¶å¼€å¯å¤šç‰ˆæœ¬æ¨¡å¼ï¼ˆå¦åˆ™æ— æ³•é‡‘ä¸é›€/å›æ»šï¼‰
      - name: Ensure Multiple Revisions mode
        shell: bash
        run: |
          set -euo pipefail
          az extension add --name containerapp --upgrade
          az containerapp update \
            -g "${{ env.AZURE_RESOURCE_GROUP }}" \
            -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
            --revisions-mode multiple

      # 2) éƒ¨ç½²æ–°ç‰ˆï¼ˆä¼šåˆ›å»ºæ–° revisionï¼‰
      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          imageToDeploy: ${{ steps.image-prep.outputs.image_url }}
          registryUrl: ${{ env.REGISTRY }}
          registryUsername: ${{ github.actor }}
          registryPassword: ${{ secrets.GITHUB_TOKEN }}

      # 3) Canaryï¼šlabel ç›´è¿æµ‹æ´»(0%) -> 10% -> 50% -> 100% + è‡ªåŠ¨å›æ»š
      - name: Canary rollout logic
        shell: bash
        run: |
          set -euo pipefail

          RG="${{ env.AZURE_RESOURCE_GROUP }}"
          APP="${{ env.AZURE_CONTAINER_APP_NAME }}"

          echo "ğŸ” Resolving FQDN..."
          FQDN=$(az containerapp show -g "$RG" -n "$APP" --query "properties.configuration.ingress.fqdn" -o tsv)
          if [ -z "$FQDN" ] || [ "$FQDN" = "None" ]; then
            echo "âŒ Ingress FQDN not found. Ensure External Ingress is enabled in ACA."
            exit 1
          fi

          # æœ€æ–°éƒ¨ç½²çš„ revisionï¼ˆæŒ‰ createdTime æ’åºå–æœ€æ–°ï¼‰
          NEW_REV=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by([].{name:name, created:properties.createdTime}, &created)[-1].name" -o tsv)

          if [ -z "$NEW_REV" ] || [ "$NEW_REV" = "None" ]; then
            echo "âŒ Failed to resolve NEW_REV."
            exit 1
          fi

          # å½“å‰ç¨³å®šç‰ˆï¼štrafficWeight > 0 ä¸”æœ€å¤§ï¼ˆå¯èƒ½ä¸ºç©ºï¼šé¦–æ¬¡éƒ¨ç½²ï¼‰
          STABLE_REV=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by([?properties.trafficWeight!=null && properties.trafficWeight>`0`].{name:name, w:properties.trafficWeight}, &w)[-1].name" -o tsv || true)

          echo "ğŸ†• New Revision: $NEW_REV"
          echo "ğŸ›¡ï¸ Stable Revision: ${STABLE_REV:-<none>}"

          # label URLï¼ˆæ¨èç”¨ label å‰ç½®ï¼šcanary---<FQDN>ï¼‰
          CANARY_URL="https://canary---${FQDN}/health"
          MAIN_URL="https://${FQDN}/health"

          echo "ğŸ©º Canary URL: $CANARY_URL"
          echo "ğŸ©º Main URL:   $MAIN_URL"

          check_health() {
            local url="$1"
            local timeout="${2:-10}"
            echo "ğŸ” Testing: $url"
            for i in {1..12}; do
              if curl -fsS --max-time "$timeout" "$url" >/dev/null 2>&1; then
                echo "âœ… Health check passed!"
                return 0
              fi
              echo "â³ Waiting for service to be ready ($i/12)..."
              sleep 10
            done
            echo "âŒ Health check failed after 2 minutes."
            return 1
          }

          rollback() {
            if [ -z "${STABLE_REV:-}" ] || [ "$STABLE_REV" = "None" ]; then
              echo "ğŸš¨ No stable revision to rollback to (likely first deployment)."
              exit 1
            fi
            echo "ğŸš¨ Rolling back 100% traffic to $STABLE_REV"
            az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=100"
            echo "ğŸ’¤ Deactivating failed new revision $NEW_REV (best-effort)"
            az containerapp revision deactivate -g "$RG" -n "$APP" --revision "$NEW_REV" || true
            exit 1
          }

          # === é¦–æ¬¡éƒ¨ç½²æˆ–æ— æ³•è¯†åˆ«ç¨³å®šç‰ˆ ===
          if [ -z "${STABLE_REV:-}" ] || [ "$STABLE_REV" = "None" ] || [ "$NEW_REV" = "$STABLE_REV" ]; then
            echo "âš ï¸ First deployment (or no stable revision). Route 100% to NEW_REV and health check main URL."
            az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$NEW_REV=100"
            echo "â³ Waiting for container to start (15s)..."
            sleep 15
            if ! check_health "$MAIN_URL" 15; then
              echo "âŒ First deployment failed health check."
              exit 1
            fi
            echo "ğŸ‰ First deployment success!"
            exit 0
          fi

          # === Canary éƒ¨ç½²æµç¨‹ ===

          # ç§»é™¤æ—§ canary labelï¼ˆä¸ä¾èµ– list å­—æ®µç»“æ„ï¼‰
          echo "ğŸ·ï¸ Removing any existing 'canary' label (best-effort)..."
          az containerapp revision label remove --name "$APP" --resource-group "$RG" --label canary || true

          # ç»™æ–°ç‰ˆæœ¬æ‰“ä¸Š canary label
          echo "ğŸ·ï¸ Assigning 'canary' label to $NEW_REV..."
          az containerapp revision label add \
            --name "$APP" \
            --resource-group "$RG" \
            --revision "$NEW_REV" \
            --label canary

          # é˜¶æ®µ 0ï¼š0% å†’çƒŸæµ‹è¯•ï¼ˆlabel ç›´è¿ï¼Œé¿å…æµé‡ç¨€é‡Šï¼‰
          echo "ğŸ§ª Smoke testing via label URL (0% production traffic)..."
          echo "â³ Waiting for container to start (15s)..."
          sleep 15
          if ! check_health "$CANARY_URL" 15; then rollback; fi

          # é˜¶æ®µ 1ï¼š10%
          echo "ğŸ¤ Shifting 10% traffic to new revision..."
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=90" "$NEW_REV=10"
          echo "â³ Waiting for traffic to propagate (10s)..."
          sleep 10
          if ! check_health "$CANARY_URL"; then rollback; fi

          # é˜¶æ®µ 2ï¼š50%
          echo "âš–ï¸ Shifting 50% traffic..."
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=50" "$NEW_REV=50"
          echo "â³ Waiting for traffic to propagate (10s)..."
          sleep 10
          if ! check_health "$CANARY_URL"; then rollback; fi

          # é˜¶æ®µ 3ï¼š100%
          echo "ğŸš€ Promoting to 100% traffic..."
          az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$NEW_REV=100"
          echo "â³ Waiting for traffic to propagate (5s)..."
          sleep 5
          if ! check_health "$MAIN_URL"; then rollback; fi

          # å¯é€‰ï¼šåœç”¨æ—§ç‰ˆæœ¬ï¼ˆèŠ‚çœèµ„æºï¼‰
          echo "ğŸ’¤ Deactivating old stable revision $STABLE_REV (optional)..."
          az containerapp revision deactivate -g "$RG" -n "$APP" --revision "$STABLE_REV" || true

          echo "ğŸ‰ Canary Deployment Success!"
          echo "ğŸ“Š Final state:"
          echo "  - New revision: $NEW_REV (100% traffic)"
          echo "  - Old revision: $STABLE_REV (deactivated)"
          echo "  - Canary URL: $CANARY_URL"
          echo "  - Production URL: $MAIN_URL"

      - name: Deployment Summary
        if: success()
        shell: bash
        run: |
          echo "### âœ… CD Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container App:** \`${{ env.AZURE_CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Strategy:** Canary (0% smoke â†’ 10% â†’ 50% â†’ 100%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **Production URL:** https://${{ env.AZURE_CONTAINER_APP_NAME }}.<your-aca-env-domain>/health" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed Summary
        if: failure()
        shell: bash
        run: |
          echo "### âŒ CD Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container App:** \`${{ env.AZURE_CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ Traffic should have been rolled back to the stable revision (if existed)." >> $GITHUB_STEP_SUMMARY
