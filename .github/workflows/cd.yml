# ============================================================================
# CD - Canary Deploy to Azure Container Apps
# CDæµæ°´çº¿ - é‡‘ä¸é›€éƒ¨ç½²åˆ°Azureå®¹å™¨åº”ç”¨
# ============================================================================
# Trigger: After CI workflow completes successfully
# è§¦å‘æ¡ä»¶: CIæµæ°´çº¿æˆåŠŸå®Œæˆåè‡ªåŠ¨è§¦å‘
# ============================================================================
# Deployment Strategy (éƒ¨ç½²ç­–ç•¥):
#   0% smoke test (labelç›´è¿) â†’ 10% â†’ 50% â†’ 100%
#   Health check at each stage, auto-rollback on failure
#   æ¯é˜¶æ®µå¥åº·æ£€æŸ¥ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
# ============================================================================

name: CD - Canary Deploy to Azure Container Apps

on:
  workflow_run:
    workflows: ["CI - Build Scan SBOM Sign Push to GHCR"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  AZURE_RESOURCE_GROUP: rg-genai-student-jp
  AZURE_CONTAINER_APP_NAME: serverless-rag-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy on success or manual trigger
    # ä»…åœ¨CIæˆåŠŸæˆ–æ‰‹åŠ¨è§¦å‘æ—¶éƒ¨ç½²
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Log in to Azure
        uses: azure/login@v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Prepare image URL | å‡†å¤‡é•œåƒåœ°å€
      - name: Prepare image url
        id: image-prep
        shell: bash
        run: |
          set -euo pipefail
          FULL_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
          LOWER_IMAGE=$(echo "$FULL_IMAGE" | tr '[:upper:]' '[:lower:]')

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="latest"
          else
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="sha-${SHA:0:7}"
          fi

          echo "image_url=$LOWER_IMAGE:$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ³ Using image: $LOWER_IMAGE:$TAG"

      # Resolve GHCR credentials | è§£æ GHCR å‡­æ®
      # NOTE: GITHUB_TOKEN is short-lived. For private GHCR images, use PAT.
      # æ³¨æ„ï¼šGITHUB_TOKEN æ˜¯çŸ­æœŸ tokenï¼Œç§æœ‰ GHCR å»ºè®®ä½¿ç”¨ PAT
      - name: Resolve GHCR credentials
        id: ghcr-creds
        shell: bash
        run: |
          if [ -n "${{ secrets.GHCR_USERNAME }}" ] && [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
            echo "username=${{ secrets.GHCR_USERNAME }}" >> $GITHUB_OUTPUT
            echo "token=${{ secrets.GHCR_TOKEN }}" >> $GITHUB_OUTPUT
            echo "âœ… Using GHCR_USERNAME/GHCR_TOKEN."
          else
            echo "username=${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
            echo "âš ï¸ GHCR_USERNAME/GHCR_TOKEN not set; using GITHUB_TOKEN."
            echo "âš ï¸ If GHCR image is private, pulls may fail after token expires."
          fi

      # ========== Step 1: Enable multiple revisions ==========
      # æ­¥éª¤1: å¯ç”¨å¤šç‰ˆæœ¬æ¨¡å¼ï¼ˆé‡‘ä¸é›€éƒ¨ç½²å’Œå›æ»šçš„å‰ææ¡ä»¶ï¼‰
      - name: Ensure Multiple Revisions mode
        shell: bash
        run: |
          set -euo pipefail
          az extension add --name containerapp --upgrade
          az containerapp update \
            -g "${{ env.AZURE_RESOURCE_GROUP }}" \
            -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
            --revisions-mode multiple

      # ========== Step 2: Deploy new revision ==========
      # æ­¥éª¤2: éƒ¨ç½²æ–°é•œåƒï¼ˆåˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰
      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          imageToDeploy: ${{ steps.image-prep.outputs.image_url }}
          registryUrl: ${{ env.REGISTRY }}
          registryUsername: ${{ steps.ghcr-creds.outputs.username }}
          registryPassword: ${{ steps.ghcr-creds.outputs.token }}

      # ========== Step 3: Canary rollout with robustness ==========
      # æ­¥éª¤3: é‡‘ä¸é›€å‘å¸ƒæµç¨‹ï¼ˆå¢å¼ºé²æ£’æ€§ï¼‰
      #   - é‡è¯•æœºåˆ¶: Azure CLI ç½‘ç»œæŠ–åŠ¨æ—¶è‡ªåŠ¨é‡è¯•
      #   - é˜²å¾¡æ€§ç¼–ç¨‹: å›æ»šæ—¶å…³é—­ set -e ç¡®ä¿æ‰§è¡Œå®Œæ•´
      #   - çŠ¶æ€æ ¡éªŒ: æ‰§è¡ŒåäºŒæ¬¡ç¡®è®¤æµé‡åˆ‡æ¢æˆåŠŸ
      - name: Canary rollout logic
        shell: bash
        run: |
          set -euo pipefail

          RG="${{ env.AZURE_RESOURCE_GROUP }}"
          APP="${{ env.AZURE_CONTAINER_APP_NAME }}"

          # ============================================================
          # Retry function - handles Azure CLI network flakiness
          # é‡è¯•å‡½æ•° - å¤„ç† Azure CLI ç½‘ç»œæŠ–åŠ¨
          # ============================================================
          run_with_retry() {
            local n=1
            local max=5
            local delay=10
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "âš ï¸ Command failed. Attempt $n/$max..."
                  sleep $delay
                else
                  echo "âŒ Command failed after $max attempts."
                  return 1
                fi
              }
            done
          }

          # ============================================================
          # Health check function
          # å¥åº·æ£€æŸ¥å‡½æ•°
          # ============================================================
          check_health() {
            local url="$1"
            local timeout="${2:-10}"
            echo "ğŸ” Testing: $url"
            for i in {1..12}; do
              if curl -fsS --max-time "$timeout" "$url" >/dev/null 2>&1; then
                echo "âœ… Health check passed!"
                return 0
              fi
              echo "â³ Waiting for service to be ready ($i/12)..."
              sleep 10
            done
            echo "âŒ Health check failed after 2 minutes."
            return 1
          }

          # ============================================================
          # Rollback function with defensive programming
          # å›æ»šå‡½æ•° - é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œç¡®ä¿å›æ»šè¿‡ç¨‹ä¸è¢«ä¸­æ–­
          # ============================================================
          rollback() {
            echo "ğŸš¨ INITIALIZING ROLLBACK PROCEDURE..."
            
            # Disable set -e to ensure rollback completes
            # å…³é—­ set -e ç¡®ä¿å›æ»šæµç¨‹å®Œæ•´æ‰§è¡Œ
            set +e
            
            if [ -z "${STABLE_REV:-}" ] || [ "$STABLE_REV" = "None" ]; then
              echo "ğŸ’£ CRITICAL: No stable revision found. Cannot rollback."
              exit 1
            fi

            echo "ğŸ”™ Rolling back 100% traffic to $STABLE_REV..."
            
            # Use retry mechanism for critical traffic switch
            # ä½¿ç”¨é‡è¯•æœºåˆ¶ç¡®ä¿æµé‡åˆ‡æ¢æˆåŠŸ
            run_with_retry az containerapp ingress traffic set \
              -g "$RG" -n "$APP" \
              --revision-weight "$STABLE_REV=100"
              
            if [ $? -ne 0 ]; then
              echo "â˜ ï¸ FATAL: Failed to switch traffic back to stable revision!"
              echo "   Manual intervention required immediately!"
              exit 1
            fi

            # Verify traffic switch succeeded
            # éªŒè¯æµé‡åˆ‡æ¢æ˜¯å¦æˆåŠŸ
            echo "ğŸ” Verifying traffic switch..."
            CURRENT_WEIGHT=$(az containerapp ingress traffic show -g "$RG" -n "$APP" \
              --query "sum(traffic[?revisionName=='$STABLE_REV'].weight)" -o tsv 2>/dev/null || echo "0")
            if [ "$CURRENT_WEIGHT" != "100" ]; then
              echo "âŒ Verification Failed: Stable revision only has $CURRENT_WEIGHT% traffic."
              exit 1
            else
              echo "âœ… Verification Passed: Traffic is 100% on stable revision."
            fi

            # Deactivate failed revision (non-critical, use || true)
            # åœç”¨å¤±è´¥ç‰ˆæœ¬ï¼ˆéå…³é”®æ­¥éª¤ï¼Œå¤±è´¥ä¸é˜»å¡ï¼‰
            echo "ğŸ’¤ Deactivating failed new revision $NEW_REV..."
            az containerapp revision deactivate -g "$RG" -n "$APP" --revision "$NEW_REV" 2>/dev/null || \
              echo "âš ï¸ Warning: Failed to deactivate bad revision, but traffic is safe."

            echo "âœ… Rollback procedure completed."
            exit 1
          }

          # ============================================================
          # Main deployment logic
          # ä¸»éƒ¨ç½²é€»è¾‘
          # ============================================================

          echo "ğŸ” Resolving FQDN..."
          FQDN=$(az containerapp show -g "$RG" -n "$APP" --query "properties.configuration.ingress.fqdn" -o tsv)
          if [ -z "$FQDN" ] || [ "$FQDN" = "None" ]; then
            echo "âŒ Ingress FQDN not found. Ensure External Ingress is enabled in ACA."
            exit 1
          fi

          # Get new revision (latest by createdTime)
          # è·å–æ–°ç‰ˆæœ¬ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºå–æœ€æ–°ï¼‰
          NEW_REV=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by([].{name:name, created:properties.createdTime}, &created)[-1].name" -o tsv)

          if [ -z "$NEW_REV" ] || [ "$NEW_REV" = "None" ]; then
            echo "âŒ Failed to resolve NEW_REV."
            exit 1
          fi

          # Get stable revision (highest traffic weight)
          # è·å–ç¨³å®šç‰ˆæœ¬ï¼ˆæµé‡æƒé‡æœ€é«˜çš„ç‰ˆæœ¬ï¼‰
          STABLE_REV=$(az containerapp revision list -g "$RG" -n "$APP" \
            --query "sort_by([?properties.trafficWeight!=null && properties.trafficWeight>\`0\`].{name:name, w:properties.trafficWeight}, &w)[-1].name" -o tsv || true)

          echo "ğŸ†• New Revision: $NEW_REV"
          echo "ğŸ›¡ï¸ Stable Revision: ${STABLE_REV:-<none>}"

          # Health check URLs | å¥åº·æ£€æŸ¥åœ°å€
          CANARY_URL="https://canary---${FQDN}/health"
          MAIN_URL="https://${FQDN}/health"

          echo "ğŸ©º Canary URL: $CANARY_URL"
          echo "ğŸ©º Main URL:   $MAIN_URL"

          # === First deployment (no stable revision) ===
          # === é¦–æ¬¡éƒ¨ç½²ï¼ˆæ— ç¨³å®šç‰ˆæœ¬ï¼‰===
          if [ -z "${STABLE_REV:-}" ] || [ "$STABLE_REV" = "None" ] || [ "$NEW_REV" = "$STABLE_REV" ]; then
            echo "âš ï¸ First deployment (or no stable revision). Route 100% to NEW_REV."
            run_with_retry az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$NEW_REV=100"
            echo "â³ Waiting for container to start (15s)..."
            sleep 15
            if ! check_health "$MAIN_URL" 15; then
              echo "âŒ First deployment failed health check."
              exit 1
            fi
            echo "ğŸ‰ First deployment success!"
            exit 0
          fi

          # === Canary deployment flow ===
          # === é‡‘ä¸é›€éƒ¨ç½²æµç¨‹ ===

          # Remove old canary label | ç§»é™¤æ—§çš„canaryæ ‡ç­¾
          echo "ğŸ·ï¸ Removing any existing 'canary' label..."
          az containerapp revision label remove --name "$APP" --resource-group "$RG" --label canary 2>/dev/null || true

          # Add canary label to new revision | ç»™æ–°ç‰ˆæœ¬æ‰“ä¸Šcanaryæ ‡ç­¾
          echo "ğŸ·ï¸ Assigning 'canary' label to $NEW_REV..."
          run_with_retry az containerapp revision label add \
            --name "$APP" \
            --resource-group "$RG" \
            --revision "$NEW_REV" \
            --label canary

          # Stage 0: 0% smoke test (label URL) | é˜¶æ®µ0: 0%å†’çƒŸæµ‹è¯•
          echo "ğŸ§ª Smoke testing via label URL (0% production traffic)..."
          echo "â³ Waiting for container to start (15s)..."
          sleep 15
          if ! check_health "$CANARY_URL" 15; then rollback; fi

          # Stage 1: 10% | é˜¶æ®µ1: 10%æµé‡
          echo "ğŸ¤ Shifting 10% traffic to new revision..."
          run_with_retry az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=90" "$NEW_REV=10"
          sleep 10
          if ! check_health "$CANARY_URL"; then rollback; fi

          # Stage 2: 50% | é˜¶æ®µ2: 50%æµé‡
          echo "âš–ï¸ Shifting 50% traffic..."
          run_with_retry az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$STABLE_REV=50" "$NEW_REV=50"
          sleep 10
          if ! check_health "$CANARY_URL"; then rollback; fi

          # Stage 3: 100% | é˜¶æ®µ3: 100%å…¨é‡
          echo "ğŸš€ Promoting to 100% traffic..."
          run_with_retry az containerapp ingress traffic set -g "$RG" -n "$APP" --revision-weight "$NEW_REV=100"
          sleep 5
          if ! check_health "$MAIN_URL"; then rollback; fi

          # Deactivate old revision (save resources) | åœç”¨æ—§ç‰ˆæœ¬ï¼ˆèŠ‚çœèµ„æºï¼‰
          echo "ğŸ’¤ Deactivating old stable revision $STABLE_REV..."
          az containerapp revision deactivate -g "$RG" -n "$APP" --revision "$STABLE_REV" 2>/dev/null || true

          echo "ğŸ‰ Canary Deployment Success!"
          echo "ğŸ“Š Final state:"
          echo "  - New revision: $NEW_REV (100% traffic)"
          echo "  - Old revision: $STABLE_REV (deactivated)"

      # ========== Summary ==========
      - name: Deployment Summary
        if: success()
        shell: bash
        run: |
          echo "### âœ… CD Completed | éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container App:** \`${{ env.AZURE_CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Strategy:** Canary (0% smoke â†’ 10% â†’ 50% â†’ 100%)" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²ç­–ç•¥:** é‡‘ä¸é›€ (0%å†’çƒŸ â†’ 10% â†’ 50% â†’ 100%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Robustness Features | é²æ£’æ€§ç‰¹æ€§:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Retry mechanism (5 attempts) | é‡è¯•æœºåˆ¶" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Defensive rollback (set +e) | é˜²å¾¡æ€§å›æ»š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Traffic verification | æµé‡éªŒè¯" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed Summary
        if: failure()
        shell: bash
        run: |
          echo "### âŒ CD Failed | éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Container App:** \`${{ env.AZURE_CONTAINER_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.image-prep.outputs.image_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ Traffic should have been rolled back to the stable revision." >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ æµé‡å·²è‡ªåŠ¨å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬ã€‚" >> $GITHUB_STEP_SUMMARY
