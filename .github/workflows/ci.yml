# ============================================================================
# CI - Build, Scan, SBOM, Sign, Push to GHCR
# CI流水线 - 构建、扫描、生成SBOM、签名、推送到GHCR
# ============================================================================
# Trigger: push to main (only for code/config changes, not docs)
# 触发条件: 推送到main分支（仅限代码/配置变更，不包括文档）
# ============================================================================

name: CI - Build Scan SBOM Sign Push to GHCR

on:
  push:
    branches: [main]
    paths:
      # Only trigger on code/config changes (忽略文档和workflow变更)
      - 'app/**'
      - 'scripts/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.env.example'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-scan-sign-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write        # Push to GHCR (推送到容器仓库)
      id-token: write        # Cosign OIDC keyless (无密钥签名)
    outputs:
      image_repo: ${{ steps.meta-prep.outputs.image_repo }}
      image_tag: ${{ steps.tag.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Prepare image name (lowercase) | 准备镜像名称（小写）
      - name: Prepare lowercase image repo
        id: meta-prep
        run: |
          IMAGE_REPO="${{ env.REGISTRY }}/${{ github.repository }}"
          IMAGE_REPO_LOWER=$(echo "$IMAGE_REPO" | tr '[:upper:]' '[:lower:]')
          echo "image_repo=$IMAGE_REPO_LOWER" >> $GITHUB_OUTPUT
          echo "Using image repo: $IMAGE_REPO_LOWER"

      # Prepare tag: sha-xxxxxxx | 准备标签：取commit前7位
      - name: Prepare tag
        id: tag
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "image_tag=sha-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Using tag: sha-$SHORT_SHA"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========== Step 1: Build local image for scanning ==========
      # 步骤1: 构建本地镜像用于安全扫描（不推送）
      - name: Build image locally for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: |
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
          build-args: |
            BUILD_SHA=${{ github.sha }}
            IMAGE_TAG=${{ steps.tag.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========== Step 2: Trivy security gate ==========
      # 步骤2: Trivy安全门禁 - HIGH/CRITICAL漏洞直接失败
      - name: Trivy image scan (gate)
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: image
          image-ref: ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
          format: table
          vuln-type: os,library
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      # ========== Step 3: Push image after gate passed ==========
      # 步骤3: 安全检查通过后推送镜像（sha标签 + latest标签）
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
            ${{ steps.meta-prep.outputs.image_repo }}:latest
          build-args: |
            BUILD_SHA=${{ github.sha }}
            IMAGE_TAG=${{ steps.tag.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========== Step 4: Generate SBOM ==========
      # 步骤4: 生成软件物料清单（CycloneDX格式）
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (CycloneDX JSON)
        run: |
          syft ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }} -o cyclonedx-json > sbom.cdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.tag.outputs.image_tag }}
          path: sbom.cdx.json

      # ========== Step 5: Cosign sign image ==========
      # 步骤5: 使用Cosign对镜像签名（OIDC无密钥模式）
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.2

      - name: Cosign sign image (keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}

      # Attach SBOM as attestation | 将SBOM作为证明附加到镜像
      - name: Cosign attach SBOM attestation
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest --yes \
            --predicate sbom.cdx.json \
            --type cyclonedx \
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}

      # ========== Summary ==========
      - name: Summary
        run: |
          echo "### ✅ CI Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Also tagged:** \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trivy gate:** HIGH/CRITICAL blocked" >> $GITHUB_STEP_SUMMARY
          echo "**SBOM:** sbom.cdx.json uploaded" >> $GITHUB_STEP_SUMMARY
          echo "**Cosign:** image signed + SBOM attested (OIDC keyless)" >> $GITHUB_STEP_SUMMARY
