# ============================================================================
# CI: Build → Trivy Scan → Push → SBOM → Cosign Sign → Datadog Catalog Sync
# CI: ビルド → Trivy スキャン → プッシュ → SBOM → Cosign 署名 → Datadog Catalog 同期
# ============================================================================

name: CI - Build Scan SBOM Sign Push to GHCR

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'scripts/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.env.example'
      - 'service.datadog.yaml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-scan-sign-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write       # Push to GHCR / GHCR へプッシュ
      id-token: write       # Cosign OIDC keyless signing / Cosign OIDC キーレス署名
    outputs:
      image_repo: ${{ steps.meta-prep.outputs.image_repo }}
      image_tag: ${{ steps.tag.outputs.image_tag }}
      image_digest: ${{ steps.push-image.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          docker system prune -af
          docker builder prune -af

      # Lowercase image repo name (GHCR requires lowercase)
      # イメージリポジトリ名を小文字に変換（GHCR の要件）
      - name: Prepare lowercase image repo
        id: meta-prep
        run: |
          IMAGE_REPO="${{ env.REGISTRY }}/${{ github.repository }}"
          IMAGE_REPO_LOWER=$(echo "$IMAGE_REPO" | tr '[:upper:]' '[:lower:]')
          echo "image_repo=$IMAGE_REPO_LOWER" >> $GITHUB_OUTPUT
          echo "image repo: $IMAGE_REPO_LOWER"

      # Tag format: sha-<first 7 chars> / タグ形式: sha-<先頭7文字>
      - name: Prepare tag
        id: tag
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "image_tag=sha-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "tag: sha-$SHORT_SHA"

      # Extract app version from __init__.py / __init__.py からバージョンを取得
      - name: Extract App Version
        id: version
        run: |
          VERSION=$(grep -E '^__version__\s*=\s*' app/__init__.py | cut -d '"' -f 2)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 1) Build locally for Trivy scan (no push)
      # 1) Trivy スキャン用にローカルビルド（プッシュなし）
      - name: Build image locally for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: |
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
          build-args: |
            APP_VERSION=${{ steps.version.outputs.app_version }}
            BUILD_SHA=${{ github.sha }}
            IMAGE_TAG=${{ steps.tag.outputs.image_tag }}
            PRELOAD_EMBEDDING_MODEL=0
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 2) Trivy gate: fail on HIGH/CRITICAL vulnerabilities
      # 2) Trivy ゲート: HIGH/CRITICAL 脆弱性があればビルドを失敗させる
      - name: Trivy image scan (gate)
        uses: aquasecurity/trivy-action@0.34.1
        with:
          scan-type: image
          image-ref: ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
          format: table
          vuln-type: os,library
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      # 3) Scan passed → push sha + latest tags
      # 3) スキャン通過 → sha タグと latest タグをプッシュ
      - name: Build and push Docker image
        id: push-image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
            ${{ steps.meta-prep.outputs.image_repo }}:latest
          build-args: |
            APP_VERSION=${{ steps.version.outputs.app_version }}
            BUILD_SHA=${{ github.sha }}
            IMAGE_TAG=${{ steps.tag.outputs.image_tag }}
            PRELOAD_EMBEDDING_MODEL=0
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4) Export digest for CD to deploy by digest
      # 4) CD がダイジェストでデプロイするために digest をエクスポート
      - name: Export image digest
        run: |
          DIGEST="${{ steps.push-image.outputs.digest }}"
          echo "digest: $DIGEST"
          echo "$DIGEST" > digest.txt

      - name: Upload digest artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: image-digest
          path: digest.txt

      # 5) Generate SBOM (CycloneDX format)
      # 5) SBOM を生成（CycloneDX 形式）
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.22.2

      - name: Generate SBOM (CycloneDX JSON)
        run: |
          syft ${{ steps.meta-prep.outputs.image_repo }}@${{ steps.push-image.outputs.digest }} -o cyclonedx-json > sbom.cdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: sbom-${{ steps.tag.outputs.image_tag }}
          path: sbom.cdx.json

      # 6) Cosign keyless signing (OIDC)
      # 6) Cosign キーレス署名（OIDC）
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
        with:
          cosign-release: 'v3.0.5'

      - name: Cosign sign image (keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ steps.meta-prep.outputs.image_repo }}@${{ steps.push-image.outputs.digest }}

      # Attach SBOM as attestation to the image
      # SBOM をアテステーションとしてイメージに添付
      - name: Cosign attach SBOM attestation
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest --yes \
            --predicate sbom.cdx.json \
            --type cyclonedx \
            ${{ steps.meta-prep.outputs.image_repo }}@${{ steps.push-image.outputs.digest }}

      - name: Summary
        run: |
          echo "### CI Done" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ steps.push-image.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** sha + latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy:** HIGH/CRITICAL gate passed" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM:** sbom.cdx.json uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- **Cosign:** signed + SBOM attested (OIDC keyless)" >> $GITHUB_STEP_SUMMARY

      # ---- Datadog Service Catalog Sync ----
      # ---- Datadog Service Catalog 同期 ----
      # Sync service.datadog.yaml via Software Catalog API
      # Software Catalog API 経由で service.datadog.yaml を同期
      - name: Sync Service Catalog metadata to Datadog (Software Catalog API)
        env:
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          DD_APP_KEY: ${{ secrets.DD_APP_KEY }}
          DD_SITE: us5.datadoghq.com
        run: |
          if [ -z "${DD_API_KEY:-}" ] || [ -z "${DD_APP_KEY:-}" ]; then
            echo "Skipping Datadog Service Catalog sync: DD_API_KEY or DD_APP_KEY is not configured."
            exit 0
          fi
          bash scripts/sync_datadog_catalog.sh service.datadog.yaml
