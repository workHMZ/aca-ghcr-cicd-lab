# CI: Build → Trivy scan → Push → SBOM → Cosign sign
# 代码/配置变更时触发，文档变更不触发

name: CI - Build Scan SBOM Sign Push to GHCR

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'scripts/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.env.example'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-scan-sign-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write       # push GHCR
      id-token: write       # cosign OIDC keyless
    outputs:
      image_repo: ${{ steps.meta-prep.outputs.image_repo }}
      image_tag: ${{ steps.tag.outputs.image_tag }}
      image_digest: ${{ steps.push-image.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Free disk space
        run: |
          docker system prune -af
          docker builder prune -af

      # 镜像名转小写
      - name: Prepare lowercase image repo
        id: meta-prep
        run: |
          IMAGE_REPO="${{ env.REGISTRY }}/${{ github.repository }}"
          IMAGE_REPO_LOWER=$(echo "$IMAGE_REPO" | tr '[:upper:]' '[:lower:]')
          echo "image_repo=$IMAGE_REPO_LOWER" >> $GITHUB_OUTPUT
          echo "image repo: $IMAGE_REPO_LOWER"

      # tag = sha-<前7位>
      - name: Prepare tag
        id: tag
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "image_tag=sha-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "tag: sha-$SHORT_SHA"

      # 提取应用版本号
      - name: Extract App Version
        id: version
        run: |
          VERSION=$(grep -E '^__version__\s*=\s*' app/__init__.py | cut -d '"' -f 2)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 1) 本地构建，不推送，给 Trivy 扫
      - name: Build image locally for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: |
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
          build-args: |
            APP_VERSION=${{ steps.version.outputs.app_version }}
            BUILD_SHA=${{ github.sha }}
            IMAGE_TAG=${{ steps.tag.outputs.image_tag }}
            PRELOAD_EMBEDDING_MODEL=0
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 2) Trivy 扫描，HIGH/CRITICAL 直接挂掉
      - name: Trivy image scan (gate)
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: image
          image-ref: ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
          format: table
          vuln-type: os,library
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          exit-code: "1"

      # 3) 扫描过了，推送 sha + latest 两个 tag
      - name: Build and push Docker image
        id: push-image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}
            ${{ steps.meta-prep.outputs.image_repo }}:latest
          build-args: |
            APP_VERSION=${{ steps.version.outputs.app_version }}
            BUILD_SHA=${{ github.sha }}
            IMAGE_TAG=${{ steps.tag.outputs.image_tag }}
            PRELOAD_EMBEDDING_MODEL=0
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4) 导出 digest，CD 用 digest 部署
      - name: Export image digest
        run: |
          DIGEST="${{ steps.push-image.outputs.digest }}"
          echo "digest: $DIGEST"
          echo "$DIGEST" > digest.txt

      - name: Upload digest artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-digest
          path: digest.txt

      # 5) 生成 SBOM (CycloneDX)
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM (CycloneDX JSON)
        run: |
          syft ${{ steps.meta-prep.outputs.image_repo }}@${{ steps.push-image.outputs.digest }} -o cyclonedx-json > sbom.cdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ steps.tag.outputs.image_tag }}
          path: sbom.cdx.json

      # 6) Cosign 签名 (OIDC keyless)
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.2

      - name: Cosign sign image (keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ steps.meta-prep.outputs.image_repo }}@${{ steps.push-image.outputs.digest }}

      # 把 SBOM 作为 attestation 附加到镜像
      - name: Cosign attach SBOM attestation
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest --yes \
            --predicate sbom.cdx.json \
            --type cyclonedx \
            ${{ steps.meta-prep.outputs.image_repo }}@${{ steps.push-image.outputs.digest }}

      - name: Summary
        run: |
          echo "### CI Done" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ steps.meta-prep.outputs.image_repo }}:${{ steps.tag.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ steps.push-image.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** sha + latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Trivy:** HIGH/CRITICAL gate passed" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM:** sbom.cdx.json uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- **Cosign:** signed + SBOM attested (OIDC keyless)" >> $GITHUB_STEP_SUMMARY
